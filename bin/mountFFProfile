#!/usr/bin/env bash

################################
# mountFFProfile : mount an encrypted firefox profile and close automatically
# License : GPLv3 - https://www.gnu.org/licenses/gpl-3.0.en.html
# ----- Usage -----------------
# Run it and mount the profile. Then run firefox, when you close firefox, it will unmount automatically.
# ----- Command ---------------
# mountFFProfile SRC DST CIPHER BYTES SIG
# ----- Example ---------------
# $ sudo /path/to/mountFFProfile /path/to/encrypted/profile /home/USERNAME/.mozilla/firefox/PROFILE blowfish 32 728c33a0438454e2
# ----- Desktop Entry ---------
#[Desktop Entry]
#Version=1.0
#Type=Application
#Terminal=true
#Exec=sudo /path/to/mountFFProfile /path/to/encrypted/profile /home/USERNAME/.mozilla/firefox/PROFILE blowfish 32 728c33a0438454e2
#Name=EFox
#Comment=Internet Browser firefox from Mozilla
#Icon=/usr/share/icons/Numix-Square/scalable/apps/firefox-aurora.svg
#Name[en_US]=EFox
################################

SRC=$1
DST=$2
CIPHER=$3
BYTES=$4
SIG=$5

isFirefoxRunning () {
    ps -e | grep firefox > /dev/null
}

if isFirefoxRunning ; then
    echo "ERROR:--> Firefox is running, close all windows and start again" >&2
    read
    exit 1
fi


mount.ecryptfs $SRC $DST -o ecryptfs_fnek_sig=$SIG,ecryptfs_key_bytes=$BYTES,ecryptfs_cipher=$CIPHER,ecryptfs_sig=$SIG,key=passphrase,ecryptfs_enable_filename_crypto=y,ecryptfs_passthrough=n,no_sig_cache,ecryptfs_unlink_sigs
if [ "$?" -ne "0" ]; then
    echo "ERROR:--> Mounting encountered a problem" >&2
    read
    exit 1
fi

# wait for firefox to run
echo ":--> Waiting for firefox to open..."
until isFirefoxRunning
do
    sleep 1s
done

echo ":--> Firefox Opened. Waiting for termination..."
until ! isFirefoxRunning
do
    sleep 3s
done

# unmount
umount $DST
